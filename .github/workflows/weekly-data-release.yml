name: Weekly Data Release

on:
  schedule:
    # Run every Wednesday at 8:00 PM UTC (adjust timezone as needed)
    - cron: '0 20 * * 3'
  workflow_dispatch:  # Allow manual triggering

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pages: write
      id-token: write
    
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.2'
          use-public-rspm: true
          
      - name: Setup R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          cache-version: 2
          extra-packages: |
            any::devtools
            any::piggyback
            any::fitzRoy
            any::tictoc
            any::mgcv
          needs: |
            devtools
            
      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
      - name: Run data release script
        run: |
          echo "Starting weekly data release..."
          Rscript data-raw/release-data.R
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Commit and push if changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            echo "Changes detected, committing..."
            git commit -m "ðŸ¤– Weekly data release - $(date +'%Y-%m-%d %H:%M')"
            git push
          fi
          
      - name: Create release summary
        run: |
          echo "## ðŸ“Š Weekly Data Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**AFL Season:** $(Rscript -e 'devtools::load_all(); cat(get_afl_season())')" >> $GITHUB_STEP_SUMMARY
          echo "**AFL Week:** $(Rscript -e 'devtools::load_all(); cat(get_afl_week())')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Data Updated:" >> $GITHUB_STEP_SUMMARY
          echo "- â›“ï¸ Chains data" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ˆ Play-by-play data" >> $GITHUB_STEP_SUMMARY
          echo "- âš½ Expected goals data" >> $GITHUB_STEP_SUMMARY  
          echo "- ðŸ‘¤ Player statistics" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“… Fixtures data" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸˆ Team lineups" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ† Results data" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“‹ Player details" >> $GITHUB_STEP_SUMMARY
          
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Weekly Data Release Failed',
              body: `The weekly data release workflow failed on ${new Date().toISOString()}.
              
              Please check the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.
              
              **Next scheduled run:** Next Wednesday at 8:00 PM UTC`,
              labels: ['bug', 'automation']
            })